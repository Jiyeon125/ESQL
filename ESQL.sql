CREATE DATABASE esql_2413640;
USE esql_2413640;

CREATE TABLE `member` (
  `member_id` int PRIMARY KEY AUTO_INCREMENT,
  `student_no` varchar(20) UNIQUE NOT NULL,
  `name` varchar(50) NOT NULL,
  `phone` varchar(20) NOT NULL,
  `password_hash` varchar(255) NOT NULL,
  `bank_account` varchar(255) NOT NULL,
  `is_admin` boolean NOT NULL DEFAULT false,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE `item` (
  `item_id` int PRIMARY KEY AUTO_INCREMENT,
  `category` enum('UMBRELLA','BATTERY') NOT NULL,
  `serial_no` varchar(50) UNIQUE,
  `status` enum('AVAILABLE','RENTED','LOST','BROKEN') NOT NULL DEFAULT 'AVAILABLE',
  `deposit_required` int NOT NULL DEFAULT 0
);

CREATE TABLE `rental` (
  `rental_id` int PRIMARY KEY AUTO_INCREMENT,
  `member_id` int NOT NULL,
  `item_id` int NOT NULL,
  `rented_on` datetime NOT NULL,
  `due_on` datetime NOT NULL,
  `returned_on` datetime
);

CREATE TABLE `deposit_txn` (
  `deposit_id` int PRIMARY KEY AUTO_INCREMENT,
  `member_id` int NOT NULL,
  `item_id` int NOT NULL,
  `amount` int NOT NULL,
  `reason` enum('INIT','DEPOSIT','REFUND') NOT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP
);

ALTER TABLE `member` COMMENT = '학생(회원) 정보';

ALTER TABLE `item` COMMENT = '비품(우산·보조배터리 등)';

ALTER TABLE `rental` COMMENT = '대여/반납 정보';

ALTER TABLE `deposit_txn` COMMENT = '보증금 입출금 내역';

ALTER TABLE `rental` ADD FOREIGN KEY (`member_id`) REFERENCES `member` (`member_id`);

ALTER TABLE `rental` ADD FOREIGN KEY (`item_id`) REFERENCES `item` (`item_id`);

ALTER TABLE `deposit_txn` ADD FOREIGN KEY (`member_id`) REFERENCES `member` (`member_id`);

ALTER TABLE `deposit_txn` ADD FOREIGN KEY (`item_id`) REFERENCES `item` (`item_id`);

-- 테이블 세팅 완료


-- mockdata
INSERT INTO member (student_no, name, phone, password_hash, bank_account, is_admin)
VALUES
('2410001', '김서연', '010-1234-1111', SHA2('pw1234', 256), '국민은행 123-45-00111', 0),
('2410002', '박지민', '010-1234-2222', SHA2('pw1234', 256), '신한은행 222-33-00222', 0),
('2410003', '이하윤', '010-1234-3333', SHA2('pw1234', 256), '우리은행 333-44-00333', 0),
('2410004', '최민지', '010-1234-4444', SHA2('pw1234', 256), '농협은행 444-55-00444', 0),
('2410005', '정유진', '010-1234-5555', SHA2('pw1234', 256), '하나은행 555-66-00555', 0),
('2410006', '김민재', '010-1234-6666', SHA2('pw1234', 256), '국민은행 666-77-00666', 0),
('2410007', '이도윤', '010-1234-7777', SHA2('pw1234', 256), '기업은행 777-88-00777', 0),
('2410008', '홍지우', '010-1234-8888', SHA2('pw1234', 256), '신한은행 888-99-00888', 0),
('2410009', '유가은', '010-1234-9999', SHA2('pw1234', 256), '국민은행 999-11-00999', 0),
('2410010', '서지훈', '010-5678-0000', SHA2('pw1234', 256), '기업은행 000-22-01000', 0);

INSERT INTO item (category, serial_no, status, deposit_required)
VALUES
('UMBRELLA', 'UM001', 'AVAILABLE', 6000),
('UMBRELLA', 'UM002', 'AVAILABLE', 6000),
('UMBRELLA', 'UM003', 'RENTED', 6000),
('UMBRELLA', 'UM004', 'BROKEN', 6000),
('BATTERY',  'BT001', 'AVAILABLE', 8000),
('BATTERY',  'BT002', 'RENTED', 8000),
('BATTERY',  'BT003', 'AVAILABLE', 8000),
('BATTERY',  'BT004', 'LOST', 8000),
('UMBRELLA', 'UM005', 'AVAILABLE', 6000),
('BATTERY',  'BT005', 'AVAILABLE', 8000),
('UMBRELLA', 'UM006', 'AVAILABLE', 6000),
('UMBRELLA', 'UM007', 'AVAILABLE', 6000),
('UMBRELLA', 'UM008', 'AVAILABLE', 6000),
('UMBRELLA', 'UM009', 'AVAILABLE', 6000),
('UMBRELLA', 'UM010', 'AVAILABLE', 6000),
('UMBRELLA', 'UM011', 'AVAILABLE', 6000),
('UMBRELLA', 'UM012', 'AVAILABLE', 6000),
('UMBRELLA', 'UM013', 'AVAILABLE', 6000),
('UMBRELLA', 'UM014', 'AVAILABLE', 6000),
('UMBRELLA', 'UM015', 'AVAILABLE', 6000),
('BATTERY', 'BT006', 'AVAILABLE', 8000),
('BATTERY', 'BT007', 'AVAILABLE', 8000),
('BATTERY', 'BT008', 'AVAILABLE', 8000),
('BATTERY', 'BT009', 'AVAILABLE', 8000),
('BATTERY', 'BT010', 'AVAILABLE', 8000),
('BATTERY', 'BT011', 'AVAILABLE', 8000),
('BATTERY', 'BT012', 'AVAILABLE', 8000),
('BATTERY', 'BT013', 'AVAILABLE', 8000),
('BATTERY', 'BT014', 'AVAILABLE', 8000),
('BATTERY', 'BT015', 'AVAILABLE', 8000);

INSERT INTO deposit_txn (member_id, item_id, amount, reason, created_at)
VALUES
(1, 3, 6000, 'INIT',   NOW()),
(2, 1, 6000, 'INIT',   NOW()),
(3, 2, 6000, 'INIT',   NOW()),
(4, 6, 8000, 'INIT', NOW()),
(5, 5, 6000, 'INIT', NOW()),
(6, 8, 8000, 'INIT', NOW()),
(7, 7, 6000, 'INIT', NOW()),
(8, 9, 6000, 'INIT', NOW()),
(9, 10, 8000, 'INIT', NOW()),
(10, 4, 6000, 'INIT', NOW()),
-- 반납된 건 DEPOSIT + REFUND
(3, 2, 6000, 'REFUND', NOW()),
(6, 8, 8000, 'REFUND', NOW());

INSERT INTO rental (member_id, item_id, rented_on, due_on, returned_on)
VALUES
-- 현재 RENTED 상태인 item
(1, 3, DATE_SUB(NOW(), INTERVAL 2 DAY), DATE_ADD(DATE_SUB(NOW(), INTERVAL 2 DAY), INTERVAL 3 DAY), NULL), -- UM003 현재 대여중
(2, 6, DATE_SUB(NOW(), INTERVAL 1 DAY), DATE_ADD(DATE_SUB(NOW(), INTERVAL 1 DAY), INTERVAL 3 DAY), NULL), -- BT002 현재 대여중
-- AVAILABLE 아이템들은 과거에 대여했다가 반납된 것으로 처리
(3, 1, DATE_SUB(NOW(), INTERVAL 15 DAY), DATE_SUB(NOW(), INTERVAL 12 DAY), DATE_SUB(NOW(), INTERVAL 12 DAY)), -- UM001
(4, 2, DATE_SUB(NOW(), INTERVAL 14 DAY), DATE_SUB(NOW(), INTERVAL 11 DAY), DATE_SUB(NOW(), INTERVAL 11 DAY)), -- UM002
(5, 5, DATE_SUB(NOW(), INTERVAL 10 DAY), DATE_SUB(NOW(), INTERVAL 7 DAY),  DATE_SUB(NOW(), INTERVAL 7 DAY)),  -- BT001
(6, 7, DATE_SUB(NOW(), INTERVAL 9 DAY),  DATE_SUB(NOW(), INTERVAL 6 DAY),  DATE_SUB(NOW(), INTERVAL 6 DAY)),  -- BT003
(7, 9, DATE_SUB(NOW(), INTERVAL 8 DAY),  DATE_SUB(NOW(), INTERVAL 5 DAY),  DATE_SUB(NOW(), INTERVAL 5 DAY)),  -- UM005
(8, 10, DATE_SUB(NOW(), INTERVAL 7 DAY), DATE_SUB(NOW(), INTERVAL 4 DAY),  DATE_SUB(NOW(), INTERVAL 4 DAY)),  -- BT005
-- 추가로 AVAILABLE 상태 더미들 (UM006~UM010)
(9, 11, DATE_SUB(NOW(), INTERVAL 20 DAY), DATE_SUB(NOW(), INTERVAL 17 DAY), DATE_SUB(NOW(), INTERVAL 17 DAY)),
(10, 12, DATE_SUB(NOW(), INTERVAL 18 DAY), DATE_SUB(NOW(), INTERVAL 15 DAY), DATE_SUB(NOW(), INTERVAL 15 DAY)),
(1, 13, DATE_SUB(NOW(), INTERVAL 16 DAY), DATE_SUB(NOW(), INTERVAL 13 DAY), DATE_SUB(NOW(), INTERVAL 13 DAY)),
(2, 14, DATE_SUB(NOW(), INTERVAL 13 DAY), DATE_SUB(NOW(), INTERVAL 10 DAY), DATE_SUB(NOW(), INTERVAL 10 DAY)),
(3, 15, DATE_SUB(NOW(), INTERVAL 11 DAY), DATE_SUB(NOW(), INTERVAL 8 DAY),  DATE_SUB(NOW(), INTERVAL 8 DAY)),
-- BATTERY 006~010 AVAILABLE
(4, 21, DATE_SUB(NOW(), INTERVAL 30 DAY), DATE_SUB(NOW(), INTERVAL 27 DAY), DATE_SUB(NOW(), INTERVAL 27 DAY)),
(5, 22, DATE_SUB(NOW(), INTERVAL 27 DAY), DATE_SUB(NOW(), INTERVAL 24 DAY), DATE_SUB(NOW(), INTERVAL 24 DAY)),
(6, 23, DATE_SUB(NOW(), INTERVAL 24 DAY), DATE_SUB(NOW(), INTERVAL 21 DAY), DATE_SUB(NOW(), INTERVAL 21 DAY)),
(7, 24, DATE_SUB(NOW(), INTERVAL 22 DAY), DATE_SUB(NOW(), INTERVAL 19 DAY), DATE_SUB(NOW(), INTERVAL 19 DAY)),
(8, 25, DATE_SUB(NOW(), INTERVAL 20 DAY), DATE_SUB(NOW(), INTERVAL 17 DAY), DATE_SUB(NOW(), INTERVAL 17 DAY));


select * from member;
select * from item;
select * from rental;
select * from deposit_txn
